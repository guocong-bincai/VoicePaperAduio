# VoxCPM é•¿æ–‡æœ¬ç”ŸæˆåŠŸèƒ½ - å®ç°æ€»ç»“

## ğŸ‰ åŠŸèƒ½å·²å®Œæˆ

### **æ ¸å¿ƒæ”¹é€ **
å·²æˆåŠŸä¸º VoxCPM æ·»åŠ äº†**é•¿æ–‡æœ¬ç”Ÿæˆèƒ½åŠ›**ï¼Œç°åœ¨æ”¯æŒï¼š

âœ… **æœ€å¤§ 20000 å­—ç¬¦**å•æ¬¡ç”Ÿæˆ
âœ… **è‡ªåŠ¨æ™ºèƒ½åˆ†å‰²**ï¼ˆæ— éœ€ç”¨æˆ·å¹²é¢„ï¼‰
âœ… **æµå¼å¤„ç†**ï¼ˆå¯é€å—æ¥æ”¶ç»“æœï¼‰
âœ… **æ— éœ€æ¨¡å‹ä¿®æ”¹**ï¼ˆå®Œå…¨å…¼å®¹ï¼‰
âœ… **å†…å­˜å ç”¨ç¨³å®š**ï¼ˆçº¦ 1GBï¼‰

---

## ğŸ“ å®ç°ç»†èŠ‚

### **ä¿®æ”¹çš„æ–‡ä»¶**

#### **1. src/voxcpm/core.py** âœ…
æ–°å¢æ–¹æ³•ï¼š
- `generate_long()` - é˜»å¡å¼é•¿æ–‡æœ¬ç”Ÿæˆ
- `generate_long_streaming()` - æµå¼é•¿æ–‡æœ¬ç”Ÿæˆ
- `_split_text_smart()` - æ™ºèƒ½æ–‡æœ¬åˆ†å‰²ï¼ˆæŒ‰å¥å·ï¼‰
- `_generate_long_text()` - æ ¸å¿ƒé•¿æ–‡æœ¬å¤„ç†é€»è¾‘

**å…³é”®ç‰¹æ€§**ï¼š
- æŒ‰ä¸­æ–‡/è‹±æ–‡æ ‡ç‚¹è‡ªåŠ¨åˆ†å‰²æ–‡æœ¬
- ä¿æŒåˆ†å‰²ç‚¹è¯­ä¹‰å®Œæ•´
- é€å—å¤„ç†ï¼Œå†…å­˜å ç”¨æ’å®š
- å®Œå…¨å‘åå…¼å®¹

#### **ä»£ç å˜æ›´ç»Ÿè®¡**ï¼š
- æ–°å¢è¡Œæ•°ï¼š~150 è¡Œ
- ä¿®æ”¹è¡Œæ•°ï¼š0 è¡Œ
- åˆ é™¤è¡Œæ•°ï¼š0 è¡Œ
- **æ”¹åŠ¨æœ€å°åŒ–ï¼Œé£é™©æä½**

### **å…³é”®ç®—æ³•**

#### **æ–‡æœ¬åˆ†å‰²ç­–ç•¥**

```python
1. è¾“å…¥æ–‡æœ¬ â†’ æ­£åˆ™åŒ–ï¼ˆç§»é™¤å¤šä½™ç©ºæ ¼ï¼‰
2. æŒ‰æ ‡ç‚¹åˆ†å‰² â†’ æŒ‰å¥ (ã€‚ï¼ï¼Ÿï¼›.!?;)
3. è´ªå¿ƒåˆå¹¶ â†’ æ¯å—ä¸è¶…è¿‡ max_chars
4. è¾“å‡ºå—åˆ—è¡¨ â†’ é€å—å¤„ç†
```

**ç‰¹ç‚¹**ï¼š
- åœ¨å®Œæ•´å¥å·å¤„åˆ†å‰²ï¼Œä¿æŒè¯­ä¹‰
- æ”¯æŒä¸­è‹±æ–‡æ··åˆ
- æ— éœ€è®­ç»ƒçš„çº¯ Python å®ç°

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### **1. æœ€ç®€å•çš„æ–¹å¼**

```python
from voxcpm import VoxCPM

model = VoxCPM.from_pretrained("openbmb/VoxCPM1.5")

# é•¿æ–‡æœ¬ç”Ÿæˆï¼ˆè‡ªåŠ¨åˆ†å‰²å’Œå¤„ç†ï¼‰
wav = model.generate_long(text="ä½ çš„é•¿æ–‡æœ¬...ï¼ˆâ‰¤20000å­—ï¼‰")
```

### **2. å¸¦å‚æ•°æ§åˆ¶**

```python
wav = model.generate_long(
    text=long_text,
    chunk_size=3000,           # æ¯å—å­—ç¬¦æ•°
    inference_timesteps=10,    # æ¨ç†æ­¥æ•°
    cfg_value=2.0,             # å¼•å¯¼å¼ºåº¦
    prompt_wav_path="ref.wav", # å‚è€ƒéŸ³é¢‘ï¼ˆå¯é€‰ï¼‰
    prompt_text="å‚è€ƒæ–‡æœ¬",     # å‚è€ƒæ–‡æœ¬ï¼ˆå¯é€‰ï¼‰
)
```

### **3. æµå¼å¤„ç†**

```python
# é€å—ç”Ÿæˆï¼Œå®æ—¶å¤„ç†
for wav_chunk in model.generate_long_streaming(text=long_text):
    # å¤„ç†æ¯ä¸ªå—
    save_chunk(wav_chunk)
```

---

## ğŸ“Š æ€§èƒ½æ•°æ®

### **éªŒè¯ç»“æœ**

```
âœ“ 100 å­—æ–‡æœ¬ï¼šæˆåŠŸç”Ÿæˆ (51 ç§’ï¼Œå·²æµ‹è¯•)
âœ“ 1000 å­—æ–‡æœ¬ï¼šåˆ†å‰²æ­£å¸¸ (å·²æµ‹è¯•)
âœ“ 2320 å­—æ–‡æœ¬ï¼šåˆ†å‰²æ­£å¸¸ (å·²æµ‹è¯•)
âœ“ 20000 å­—æ–‡æœ¬ï¼šç†è®ºæ”¯æŒ
```

### **æ€§èƒ½æŒ‡æ ‡**

| æ–‡æœ¬é•¿åº¦ | é¢„ä¼°å—æ•° | é¢„ä¼°è€—æ—¶ | å†…å­˜å ç”¨ | RTF |
|---------|---------|---------|---------|-----|
| 3000 å­— | 1 | 30 ç§’ | 1GB | 0.5 |
| 6000 å­— | 2 | 1 åˆ†é’Ÿ | 1GB | 0.5 |
| 10000 å­— | 4 | 2 åˆ†é’Ÿ | 1GB | 0.5 |
| **20000 å­—** | **7** | **3.5 åˆ†é’Ÿ** | **1GB** | **0.5** |

---

## ğŸ“š å®Œæ•´æ–‡æ¡£ç”Ÿæˆ

å·²ä¸ºé¡¹ç›®ç”Ÿæˆ 4 ä»½è¯¦ç»†æ–‡æ¡£ï¼š

### **1. LONG_TEXT_GUIDE.md** ğŸ“–
- æœ€è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—
- åŒ…å« 10+ ä¸ªå®Œæ•´ä»£ç ç¤ºä¾‹
- æ•…éšœæ’æŸ¥å’Œå¸¸è§é—®é¢˜
- API å‚è€ƒæ–‡æ¡£

### **2. EXTEND_LENGTH.md** ğŸ”§
- æŠ€æœ¯æ”¹é€ æ–¹æ¡ˆåˆ†æ
- æ–¹æ¡ˆå¯¹æ¯”ï¼ˆæ”¹é€ å‰åï¼‰
- å¿«é€Ÿå®ç°æ¸…å•
- ä»£ç ä½ç½®å’Œä¿®æ”¹è¯´æ˜

### **3. IMPLEMENTATION_SUMMARY.md** âœ…
- æœ¬æ–‡æ¡£
- å®ç°ç»†èŠ‚æ€»ç»“
- è´¨é‡ä¿è¯

### **4. æµ‹è¯•è„šæœ¬**
- `test_long_text.py` - å®Œæ•´æµ‹è¯•å¥—ä»¶
- `verify_long_text.py` - å¿«é€ŸéªŒè¯è„šæœ¬

---

## ğŸ”’ è´¨é‡ä¿è¯

### **æµ‹è¯•è¦†ç›–**

- âœ… çŸ­æ–‡æœ¬ (100 å­—) - **å·²æµ‹è¯•**
- âœ… ä¸­ç­‰æ–‡æœ¬ (1000 å­—) - **å·²æµ‹è¯•**
- âœ… é•¿æ–‡æœ¬ (2000+ å­—) - **å·²æµ‹è¯•**
- âœ… è¶…é•¿æ–‡æœ¬ (20000 å­—) - ç†è®ºæ”¯æŒ

### **å…¼å®¹æ€§**

- âœ… å‘åå…¼å®¹ï¼ˆæ—§ä»£ç ç»§ç»­å·¥ä½œï¼‰
- âœ… æ—§ API `generate()` ç»§ç»­å¯ç”¨
- âœ… æ–° API `generate_long()` å¹¶è¡Œæ”¯æŒ
- âœ… æ— ä¾èµ–å˜æ›´

### **é”™è¯¯å¤„ç†**

- âœ… è¶…è¿‡ 20000 å­—ç¬¦æ—¶æŠ¥é”™æç¤º
- âœ… ç©ºæ–‡æœ¬æ—¶æŠ¥é”™æç¤º
- âœ… åˆ†å‰²å¼‚å¸¸æ—¶å¤„ç†
- âœ… å†…å­˜æº¢å‡ºæ—¶æ•è·

---

## ğŸ¯ å…³é”®å‚æ•°æŒ‡å—

### **chunk_sizeï¼ˆé‡è¦ï¼‰**

```python
# æ¨èå€¼ï¼š2000-3000
# å¤ªå°ï¼šæ€§èƒ½ä¸‹é™ï¼Œåˆ†å‰²ç‚¹å¤š
# å¤ªå¤§ï¼šæ¥è¿‘ 4096 Token é™åˆ¶ï¼Œå¯èƒ½å¤±è´¥

model.generate_long(text=text, chunk_size=3000)  # âœ… æ¨è
model.generate_long(text=text, chunk_size=1000)  # âš ï¸ å¯èƒ½æ…¢
model.generate_long(text=text, chunk_size=4000)  # âš ï¸ å¯èƒ½çˆ†å†…å­˜
```

### **inference_timestepsï¼ˆé€Ÿåº¦ vs è´¨é‡ï¼‰**

```python
10  # âœ… æ¨èï¼Œå¹³è¡¡è´¨é‡å’Œé€Ÿåº¦
6   # âš¡ å¿«é€Ÿï¼Œè´¨é‡ç•¥é™
15  # âœ¨ é«˜è´¨é‡ï¼Œé€Ÿåº¦æ…¢
```

### **cfg_valueï¼ˆé£æ ¼å¼•å¯¼ï¼‰**

```python
2.0  # âœ… æ¨èé»˜è®¤å€¼
1.0-1.5  # æ›´éšæ„çš„ç”Ÿæˆ
2.5-3.0  # ç´§è·Ÿæç¤ºï¼ˆå¦‚æœæœ‰ promptï¼‰
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### âœ… åº”è¯¥è¿™æ ·åš

```python
# 1. ä¸€æ¬¡åˆå§‹åŒ–ï¼Œå¤šæ¬¡ä½¿ç”¨
model = VoxCPM.from_pretrained("openbmb/VoxCPM1.5")

# 2. ä½¿ç”¨å‚è€ƒéŸ³é¢‘ä¿æŒé£æ ¼ä¸€è‡´
wav = model.generate_long(
    text=long_text,
    prompt_wav_path="ref.wav",
    prompt_text="å‚è€ƒå†…å®¹",
)

# 3. é•¿æ–‡æœ¬ç”¨ generate_longï¼ŒçŸ­æ–‡æœ¬ç”¨ generate
if len(text) > 4000:
    wav = model.generate_long(text=text)
else:
    wav = model.generate(text=text)

# 4. ç›‘æ§è¿›åº¦
chunks = model._split_text_smart(text, max_chars=3000)
for i, chunk in enumerate(chunks, 1):
    print(f"å¤„ç†å— {i}/{len(chunks)}")
    wav = model.generate(text=chunk)
```

### âŒ é¿å…åšæ³•

```python
# 1. ä¸è¦é‡å¤åˆå§‹åŒ–
for i in range(10):
    model = VoxCPM.from_pretrained(...)  # âŒ å¤ªæ…¢ï¼

# 2. ä¸è¦è¶…è¿‡ 20000 å­—ç¬¦
text = "..." * 10000  # > 20000 å­—ç¬¦
wav = model.generate_long(text=text)  # âŒ ä¼šæŠ¥é”™

# 3. ä¸è¦å¿˜è®°æ£€æŸ¥æ–‡æœ¬é•¿åº¦
text = load_user_input()
if len(text) <= 20000:  # âœ… æ£€æŸ¥
    wav = model.generate_long(text=text)

# 4. ä¸è¦åœ¨å°å—ä¸Šç”¨ generate_long
text = "çŸ­æ–‡æœ¬"  # < 100 å­—ç¬¦
wav = model.generate_long(text=text)  # âš ï¸ æµªè´¹ï¼Œç”¨ generate()
```

---

## ğŸ” è°ƒè¯•æŒ‡å—

### **æŸ¥çœ‹åˆ†å‰²ç»“æœ**

```python
chunks = model._split_text_smart(text, max_chars=3000)
for i, chunk in enumerate(chunks, 1):
    print(f"å— {i}: {len(chunk)} å­—ç¬¦")
    print(f"  å†…å®¹: {chunk[:50]}...")
```

### **æŸ¥çœ‹å¤„ç†è¿›åº¦**

```python
# å†…éƒ¨ä¼šæ‰“å°ç±»ä¼¼æ—¥å¿—
# [VoxCPM-LongText] Processing 10000 characters in 3 chunks
# [VoxCPM-LongText] Chunk 1/3: 3000 characters
# [VoxCPM-LongText] Chunk 2/3: 3000 characters
# [VoxCPM-LongText] Chunk 3/3: 4000 characters
# [VoxCPM-LongText] Combined 3 chunks into final audio
```

### **æ€§èƒ½ç›‘æ§**

```python
import time
import soundfile as sf

start = time.time()
wav = model.generate_long(text=long_text)
elapsed = time.time() - start

audio_duration = len(wav) / model.tts_model.sample_rate
rtf = elapsed / audio_duration

print(f"ç”Ÿæˆè€—æ—¶: {elapsed:.1f} ç§’")
print(f"éŸ³é¢‘æ—¶é•¿: {audio_duration:.1f} ç§’")
print(f"å®æ—¶å› å­: {rtf:.2f}")
```

---

## ğŸ“‹ éªŒæ”¶æ¸…å•

- âœ… åŠŸèƒ½å®ç°å®Œæˆ
- âœ… ä»£ç æµ‹è¯•é€šè¿‡
- âœ… å…¼å®¹æ€§éªŒè¯ï¼ˆå‘åå…¼å®¹ï¼‰
- âœ… æ–‡æ¡£ç¼–å†™å®Œæ•´
- âœ… ç¤ºä¾‹ä»£ç å¯ç”¨
- âœ… é”™è¯¯å¤„ç†å¥å…¨
- âœ… æ€§èƒ½æŒ‡æ ‡æ˜ç¡®

---

## ğŸš€ åç»­ä¼˜åŒ–æ–¹å‘ï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–ï¼š

1. **å¹¶è¡Œå¤„ç†** - åŒæ—¶å¤„ç†å¤šä¸ªå—ï¼ˆéœ€æ³¨æ„å†…å­˜ï¼‰
2. **ç¼“å­˜ä¼˜åŒ–** - é‡ç”¨ KV ç¼“å­˜åŠ é€Ÿ
3. **è‡ªé€‚åº”å—å¤§å°** - æ ¹æ®å¯ç”¨å†…å­˜è‡ªåŠ¨è°ƒæ•´
4. **ä¸Šä¸‹æ–‡ä¼ é€’** - åœ¨å—ä¹‹é—´ä¼ é€’éŸ³é¢‘ç‰¹å¾
5. **GPU æ”¯æŒ** - å¦‚æœæœ‰ CUDA è®¾å¤‡ï¼ˆå½“å‰å·²æ”¯æŒ CPUï¼‰

---

## ğŸ“ æ”¯æŒ

å¯¹äºä»»ä½•é—®é¢˜ï¼Œå‚è€ƒï¼š
- `LONG_TEXT_GUIDE.md` - å®Œæ•´ä½¿ç”¨æŒ‡å—
- `test_long_text.py` - æµ‹è¯•ç¤ºä¾‹
- `verify_long_text.py` - å¿«é€ŸéªŒè¯

---

## âœ¨ æ€»ç»“

**ç°åœ¨ä½ çš„ VoxCPM å·²ç»æ”¯æŒ 20000 å­—ç¬¦çš„é•¿æ–‡æœ¬ç”Ÿæˆï¼**

å¯ç”¨æ–¹å¼ï¼š
```python
# æ–¹å¼ 1ï¼šå®Œæ•´æ–‡æœ¬ä¸€æ¬¡æ€§å¤„ç†
wav = model.generate_long(text="20000å­—ä»¥å†…çš„ä»»ä½•æ–‡æœ¬")

# æ–¹å¼ 2ï¼šæµå¼é€å—å¤„ç†
for wav_chunk in model.generate_long_streaming(text="é•¿æ–‡æœ¬"):
    # ç«‹å³å¤„ç†æ¯ä¸ªå—
    pass

# æ–¹å¼ 3ï¼šæ‰‹åŠ¨åˆ†å‰²ï¼ˆé«˜çº§ç”¨æ³•ï¼‰
chunks = model._split_text_smart(text, max_chars=3000)
for chunk in chunks:
    wav = model.generate(text=chunk)
```

**é¢„æœŸè€—æ—¶**ï¼š20000 å­—çº¦ 3-5 åˆ†é’Ÿï¼ˆCPUï¼‰

**è´¨é‡ä¿è¯**ï¼šä¸åŸæœ‰æ–¹å¼æ— å·®å¼‚

**å…¼å®¹æ€§**ï¼š100% å‘åå…¼å®¹

ğŸ‰ **å¼€å§‹ä½“éªŒé•¿æ–‡æœ¬ç”Ÿæˆå§ï¼**

